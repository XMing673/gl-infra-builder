From 984eea25b8a38184a24af43ceceeaf8c540acf02 Mon Sep 17 00:00:00 2001
From: Jianhui Zhao <jianhui.zhao@gl-inet.com>
Date: Mon, 19 Sep 2022 14:11:34 +0800
Subject: [PATCH] target/mediatek: fix mdio read/write of mtk_eth_soc

Signed-off-by: Jianhui Zhao <jianhui.zhao@gl-inet.com>
---
 .../files-5.4/drivers/net/ethernet/mediatek/mtk_eth_dbg.c | 8 ++++----
 .../files-5.4/drivers/net/ethernet/mediatek/mtk_eth_soc.c | 8 ++++----
 .../files-5.4/drivers/net/ethernet/mediatek/mtk_sgmii.c   | 5 ++++-
 3 files changed, 12 insertions(+), 9 deletions(-)

diff --git a/target/linux/mediatek/files-5.4/drivers/net/ethernet/mediatek/mtk_eth_dbg.c b/target/linux/mediatek/files-5.4/drivers/net/ethernet/mediatek/mtk_eth_dbg.c
index 0d5ca16e4f..8977afb21c 100755
--- a/target/linux/mediatek/files-5.4/drivers/net/ethernet/mediatek/mtk_eth_dbg.c
+++ b/target/linux/mediatek/files-5.4/drivers/net/ethernet/mediatek/mtk_eth_dbg.c
@@ -417,7 +417,7 @@ void mii_mgr_read_combine(struct mtk_eth *eth, u32 phy_addr, u32 phy_register,
 		*read_data = mt7530_mdio_r32(eth, phy_register);
 
 	else
-		*read_data = _mtk_mdio_read(eth, phy_addr, phy_register);
+		*read_data = mdiobus_read(eth->mii_bus, phy_addr, phy_register);
 }
 
 void mii_mgr_write_combine(struct mtk_eth *eth, u16 phy_addr, u16 phy_register,
@@ -427,17 +427,17 @@ void mii_mgr_write_combine(struct mtk_eth *eth, u16 phy_addr, u16 phy_register,
 		mt7530_mdio_w32(eth, phy_register, write_data);
 
 	else
-		_mtk_mdio_write(eth, phy_addr, phy_register, write_data);
+		mdiobus_write(eth->mii_bus, phy_addr, phy_register, write_data);
 }
 
 static void mii_mgr_read_cl45(struct mtk_eth *eth, u16 port, u16 devad, u16 reg, u16 *data)
 {
-	*data = _mtk_mdio_read(eth, port, mdiobus_c45_addr(devad, reg));
+	*data = mdiobus_read(eth->mii_bus, port, mdiobus_c45_addr(devad, reg));
 }
 
 static void mii_mgr_write_cl45(struct mtk_eth *eth, u16 port, u16 devad, u16 reg, u16 data)
 {
-	_mtk_mdio_write(eth, port, mdiobus_c45_addr(devad, reg), data);
+	mdiobus_write(eth->mii_bus, port, mdiobus_c45_addr(devad, reg), data);
 }
 
 int mtk_do_priv_ioctl(struct net_device *dev, struct ifreq *ifr, int cmd)
diff --git a/target/linux/mediatek/files-5.4/drivers/net/ethernet/mediatek/mtk_eth_soc.c b/target/linux/mediatek/files-5.4/drivers/net/ethernet/mediatek/mtk_eth_soc.c
index a05cd19df6..acc56a39ef 100755
--- a/target/linux/mediatek/files-5.4/drivers/net/ethernet/mediatek/mtk_eth_soc.c
+++ b/target/linux/mediatek/files-5.4/drivers/net/ethernet/mediatek/mtk_eth_soc.c
@@ -2765,10 +2765,10 @@ static int mtk_open(struct net_device *dev)
 		 */
 
 		// clear interrupt source for gpy211
-		_mtk_mdio_read(eth, phylink_priv->phyaddr, 0x1A);
+		mdiobus_read(eth->mii_bus, phylink_priv->phyaddr, 0x1A);
 
 		// enable link status change interrupt for gpy211
-		_mtk_mdio_write(eth, phylink_priv->phyaddr, 0x19, 0x0001);
+		mdiobus_write(eth->mii_bus, phylink_priv->phyaddr, 0x19, 0x0001);
 
 		phylink_priv->dev = dev;
 
@@ -2828,9 +2828,9 @@ static int mtk_stop(struct net_device *dev)
 
 	phy_node = of_parse_phandle(mac->of_node, "phy-handle", 0);
 	if (phy_node) {
-		val = _mtk_mdio_read(eth, 0, 0);
+		val = mdiobus_read(eth->mii_bus, 0, 0);
 		val |= BMCR_PDOWN;
-		_mtk_mdio_write(eth, 0, 0, val);
+		mdiobus_write(eth->mii_bus, 0, 0, val);
 	} else if (eth->sgmii->regmap[mac->id]) {
 		regmap_read(eth->sgmii->regmap[mac->id], SGMSYS_QPHY_PWR_STATE_CTRL, &val);
 		val |= SGMII_PHYA_PWD;
diff --git a/target/linux/mediatek/files-5.4/drivers/net/ethernet/mediatek/mtk_sgmii.c b/target/linux/mediatek/files-5.4/drivers/net/ethernet/mediatek/mtk_sgmii.c
index 8198c7cb59..e0406e2b86 100755
--- a/target/linux/mediatek/files-5.4/drivers/net/ethernet/mediatek/mtk_sgmii.c
+++ b/target/linux/mediatek/files-5.4/drivers/net/ethernet/mediatek/mtk_sgmii.c
@@ -111,7 +111,10 @@ int mtk_sgmii_setup_mode_force(struct mtk_sgmii *ss, unsigned int id,
 		val |= SGMII_SPEED_10;
 		break;
 	case SPEED_100:
-		val |= SGMII_SPEED_100;
+		if (state->interface == PHY_INTERFACE_MODE_2500BASEX)
+			val |= SGMII_SPEED_1000;
+		else
+			val |= SGMII_SPEED_100;
 		break;
 	case SPEED_2500:
 	case SPEED_1000:
-- 
2.34.1

